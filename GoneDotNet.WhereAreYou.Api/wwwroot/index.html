
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Where Are You?</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" rel="stylesheet" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>

    <script>
        var map, datasource;

        function getMap() {
            map = new atlas.Map('myMap', {
                center: [-79.3896317, 43.6425701],
                zoom: 12,
                view: 'Auto',
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: ''
                }
            });

            map.events.add('ready', function () {
                //     window.setInterval(function () {
                //         fetch("https://acr.ngrok.app/companies/gonedotnet")
                //             .then(response => response.json())
                //             .then(data => {
                //                 try
                //                 {
                //                     map.markers.clear();
                //                     for (var i = 0; i < data.length; i++)
                //                         addMarker(map, data[i]);
                //                 }
                //                 catch (error)
                //                 {
                //                     console.error("Error logging data:", error);
                //                 }
                //             })
                //             .catch(error => console.error('Error fetching company data:', error));
                //     }, 3000);

                const evtSource = new EventSource("https://acr.ngrok.app/drivers");
                evtSource.onopen = (event) => {
                    console.log("Connection to server opened.");
                };
                evtSource.onerror = (event) => {
                    console.error(event);
                };
                evtSource.onmessage = (event) => {
                    console.log(event);
                    try {
                        const data = JSON.parse(event.data);
                        addMarker(map, data);
                    } catch (error) {
                        console.error("Error parsing JSON data:", error);
                    }
                };

                map.layers.add([
                    new atlas.layer.LineLayer(datasource, null, {
                        strokeColor: 'DarkOrchid',
                        strokeWidth: 3
                    }),

                    new atlas.layer.SymbolLayer(datasource, null, {
                        lineSpacing: 100,
                        placement: 'line',
                        iconOptions: {
                            image: 'arrow-icon',
                            allowOverlap: true,
                            anchor: 'center',
                            size: 0.8
                        }
                    })
                ]);
            });
        }
        
        function addMarker(map, data) {
            // datasource.add(new atlas.data.Feature(new atlas.data.LineString([
            //     [data.Longitude, data.Latitude]
            // ])));
            // map.setCamera({
            //     center: [data.Longitude, data.Latitude],
            //     zoom: 12,
            //     type: 'fly',
            //     duration: 1000
            // });

            // Create a custom HTML marker with directional arrow
            var markerHtml = document.createElement('div');
            markerHtml.innerHTML = `
                            <div style="text-align: center; transform: rotate(${data.heading}deg); transform-origin: center;">
                                <div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid DodgerBlue; margin: 0 auto;"></div>
                            </div>
                        `;
            var marker = new atlas.HtmlMarker({
                htmlContent: markerHtml.outerHTML,
                position: [data.longitude, data.latitude],
                anchor: 'center'
            });

            // Create popup with driver information
            var timestamp = new Date(data.timestamp);
            var formattedTime = timestamp.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit'
            });

            var popup = new atlas.Popup({
                content: `
                                <div style="padding: 10px;">
                                    <strong>${data.driverName}</strong><br/>
                                    <span style="font-size: 12px; color: #666;">Time: ${formattedTime}</span><br/>
                                    <span style="font-size: 12px; color: #666;">Speed: ${data.speed ? data.speed.toFixed(1) : 0} km</span>
                                </div>
                            `,
                position: [data.longitude, data.latitude],
                pixelOffset: [0, -30]
            });

            // Add click event to marker to show popup
            map.events.add('click', marker, function() {
                popup.open(map);
            });

            map.markers.add(marker);
        }
    </script>
</head>
<body onload="getMap()">
    <div id="myMap" style="position:relative;width:100%;min-width:290px;height:600px;"></div>
</body>
</html>
